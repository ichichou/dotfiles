= How to Initialize macOS
:lang: ja
:icons: font
:experimental:
:sectnums:
:sectnumlevels: 1
:table-caption!:

== クリーンインストール前の作業
=== Homebrew
* `Brewfile` を手動で更新。

=== Mackup
. `.mackup.cfg` から管理対象のアプリを確認。必要に応じて追加・削除。
. `$ mackup -f backup` ：管理対象アプリの設定ファイルを Mackup フォルダにコピーし、元の場所にはシンボリックリンクを生成。
. `$ mackup uninstall` ：Mackup フォルダ内の設定ファイルを元の場所にコピー（Mackup フォルダ内のファイルはそのまま残る）。

=== AquaSKK ユーザー辞書をバックアップ
. {blank}
+
----
sudo cp \
~/Library/Application\ Support/AquaSKK/skk-jisyo.utf8 \
~/Box/Setting_files/AquaSKK/skk-jisyo.utf8
----
+
AquaSKK のユーザー辞書はシンボリックリンクでは機能しないようなので、都度バックアップする必要がある。

== クリーンインストール

=== クリーンインストール手順
. `Command-R` を押しながら Mac を起動 →「macOSユーティリティ」が起動する。
. 「ディスクユーティリティ」を開く。
. `Macintosh HD - Data` を選択し、`ボリューム` の `−` をクリックして削除する。
. `Macintosh HD` を選択し、`消去` する（フォーマットは `APFS`）。
. 「ディスクユーティリティ」を閉じる。
. 「macOSを再インストール」を開いてインストールを進める。

=== インストール時の設定
. 「コンピュータアカウントを作成」
+
[%autowidth, cols="3*a"]
|===
|`フルネーム`
|`kazu`
|ユーザー名。コンピュータ名やローカルホスト名にも影響する

|`アカウント名`
|`kazu`
|ホームディレクトリ名
|===

. 「エクスプレス設定」
** `設定をカスタマイズ` から不必要なものを無効化。

== Homebrew

=== Homebrew のインストール
. `$ xcode-select --install` ：Command Line Tools をインストール（Xcode 自体は不要）。
. https://brew.sh/[Homebrew 公式サイト]のコマンドを実行。
** `$ /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"`

=== アプリケーションをインストール
. App Store にサインイン（mas-cli 用）。
. `$ cd ~/Downloads/`
. `$ curl -LO https://raw.githubusercontent.com/ichichou/dotfiles/master/Brewfile`
. `$ brew bundle`

== シェルスクリプトによる初期化

=== init.sh
. `$ cd ~`
. `$ git clone https://github.com/ichichou/dotfiles.git`
. `$ sh ~/dotfiles/init.sh`

=== pm.sh
NOTE: `pm.sh` 自体は実行しない（うまく機能しないため）。以下のコードを手動で実行する。

.fisher
. `$ curl https://git.io/fisher --create-dirs -sLo ~/.config/fish/functions/fisher.fish`
. `$ fisher self-update`
. `$ fisher` ： `fishfile` をもとに自動インストール。

.gem
. `$ which gem` ： `/usr/local/opt/ruby/bin/gem` にパスが通っているか確認。
. `$ gem update --system`
. `$ gem install asciidoctor asciidoctor-pdf asciidoctor-pdf-cjk asciidoctor-diagram rouge`

.npm
. `$ npm -g install npm`
. `$ npm -g install eslint prettier eslint-plugin-prettier htmlhint`

=== macos.sh
. `$ sh ~/dotfiles/macos.sh`
. Mac を再起動する。
** 再起動後、設定が反映されるまで少し時間がかかるかもしれない。

NOTE: `macos.sh` の中には効き目が不明なものもあるため、下記のものだけ手動で設定している。

* `defaults write -g InitialKeyRepeat -int 10`
* `defaults write -g KeyRepeat -int 1`
* `defaults write com.apple.dock expose-animation-duration -float 0`
* `defaults write com.apple.dock autohide-time-modifier -float 0.15`
* `defaults write com.apple.dock autohide-delay -float 0`
* `defaults write com.apple.dock showhidden -bool true`

== Mackup

NOTE: 設定が反映されないアプリが一部あるため、Mackup は使わず、ひとまず手動で設定してみる。

* `$ mackup restore` ： Mackup 管理対象アプリの設定ファイルを復元（シンボリックリンク）。
* 後述の BetterTouchTool と Dash は、Mackup で復元できれば手動設定は不要。

== 手動設定
=== AquaSKK のユーザー辞書を復元
NOTE: 現状、AquaSKK は Catalina でうまく機能しない。Brewfile ではインストールせず、あとから入れて様子をみる。

. Box Drive にサインイン。
. {blank}
+
----
sudo cp \
~/Box/Setting_files/AquaSKK/skk-jisyo.utf8 \
~/Library/Application\ Support/AquaSKK/skk-jisyo.utf8
----

. AquaSKK の環境設定から辞書を `~/Library/Application\ Support/AquaSKK/skk-jisyo.utf8` に設定する。
** `変更…` からではなくパスを直接入力する必要あり。

=== Terminal
. https://cocopon.github.io/iceberg.vim/[Iceberg プロファイル]をインポートする。
. 環境設定：
** 開くシェル： `/usr/local/bin/fish`
** フォント： `Hack Regular 12 pt.`
** サイズ： `160 × 50`
** 曖昧幅文字を全角で表示する。

=== Google Chrome
* アカウントを同期する前に、`kabankobo` と `private` のユーザーを作成する。
* Mouse Dictionary にlink:https://booth.pm/ja/items/777563[英辞郎データ]を読み込む。
* https://greasyfork.org/ja/scripts/14391-zenzawatch[ZenzaWatch] をインストールする。

=== TotalSpaces2
NOTE: Catalina では TotalSpaces2 がうまく機能しない。動かす設定方法もあるようだがうまくいかなかった。使用しないのが無難。

. Mac をリカバリーモードで起動し、Terminal で `$ csrutil disable` を実行する。
. https://totalspaces.binaryage.com/[TotalSpaces2] をインストール。
** 現状、TotalSpaces2 は Homebrew でインストールできない。

=== Box Drive
* `Setting_files` を `オフライン利用可` にする。

=== Alfred
* 「Google Search with Selected Text」のワークフローを設定。

=== diff-highlight にパスを通す
. {blank}
+
----
sudo ln -snfv \
/usr/local/share/git-core/contrib/diff-highlight/diff-highlight \
/usr/local/bin/diff-highlight
----

=== BetterTouchTool
NOTE: BetterTouchTool は設定ファイルをインポートせず、手動で設定する。なぜかインポートしたトリガーの一部が機能しないため。

[%autowidth, cols="3*a"]
.環境設定
|===
.2+h|ウィンドウスナップと移動
|ウィンドウの移動 |kbd:[Control+Option+ドラッグ]
|ウィンドウのサイズ変更 |kbd:[Control+Option+Command+ドラッグ]
|===

[%autowidth, cols="3*a"]
.トラックパッド
|===
.9+h|すべてのアプリ
|シングルフィンガーフォースクリック |kbd:[Command+クリック]
|3本指でタップ |kbd:[Command+クリック]
|3本指で上にスワイプ |kbd:[Command+N]
|3本指でスワイプダウン |kbd:[Command+W]
|3本指で左にスワイプ |kbd:[Control+Tab]
|3本指で右にスワイプ |kbd:[Shift+Control+Tab]
|4本指でクリック |kbd:[Application Expose]
|4本指で上にスワイプ |kbd:[Mission Control]
|4本指で下にスワイプ |kbd:[Open Launchpad]

.3+h|Finder
|2本指で左にスワイプ |kbd:[Command+\]]
|2本指で右にスワイプ |kbd:[Command+[]
|3本指で上にスワイプ |kbd:[Command+T]

.3+h|Chrome
|3本指で上にスワイプ |kbd:[Command+T]
|Shift + 3本指で左にスワイプ |kbd:[Shift+Command+PageDown]
|Shift + 3本指で右にスワイプ |kbd:[Shift+Command+PageUp]
|===

[%autowidth, cols="3*a"]
.マウスジェスチャー
|===
.6+h|すべてのアプリ
|↓→ |なし
|↓← |なし
|↑→ |kbd:[Command+\]]
|↑← |kbd:[Command+[]
|←→ |`スペースを右に移動`
|→← |`スペースを左に移動`
|===

[%autowidth, cols="3*a"]
.キーボードショートカット
|===
.4+h|すべてのアプリ
|kbd:[Control+Option+↑] |ウィンドウを最大化
|kbd:[Control+Option+→] |ウィンドウを右に最大化
|kbd:[Control+Option+←] |ウィンドウを左に最大化
|kbd:[Control+Option+↓] |古いウィンドウサイズに復元
|===

=== Dash
[%autowidth, cols="2*a"]
.Placeholder
|===
|@time |`H:mm`
|@date |`yyyy-MM-dd`
|===

[%autowidth, cols="2*a"]
.Snippets
|===
|`;date` |`@date`
|`;time` |`@time`
|`@k\***` |`@k\***.com`
|`@gmail` |`@gmail.com`
|`\***@` |`\***@k\***.com`
|`\***@` |`\***@gmail.com`
|===

== Mac のシステム環境設定

=== Finder
. 環境設定からもろもろ設定。
. 表示オプション：
** `表示 > 表示オプションを表示` からもろもろ設定し、`デフォルトとして使用` から反映。
** ホームディレクトリで表示オプションを表示すると `“ライブラリ”フォルダを表示` が出現する。
. 次のコマンドを実行（fish 以外で）：
.. `$ sudo find / -name ".DS_Store" | xargs rm -rf` ：すべてのディレクトリから `.DS_Store` を探し出して削除。
.. `$ killall Finder`

=== キーボードショートカット
[%autowidth, cols="2*a"]
.LaunchpadとDock
|===
|Dockを自動的に表示/非表示のオン/オフ |チェック外す
|Launchpadを表示 |チェック外す
|===

[%autowidth, cols="2*a"]
.Mission Control
|===
|Mission Control |kbd:[Control+Option+Command+↑]
|アプリケーションウインドウ |kbd:[Shift+Control+Option+Command+↓]
|左の操作スペースに移動 |kbd:[Shift+Control+Option+Command+←]
|右の操作スペースに移動 |kbd:[Shift+Control+Option+Command+→]
|デスクトップ1へ切り替え |kbd:[Shift+Control+Option+Command+1]
|デスクトップ2へ切り替え（以下デスクトップ10まで） |kbd:[Shift+Control+Option+Command+2]
|===

[%autowidth, cols="2*a"]
.入力ソース
|===
|前の入力ソースを選択 |チェック外す
|入力メニューの次のソースを選択 |チェック外す
|===

NOTE: `前の入力ソースを選択` はチェックを外しても、たびたび勝手にチェックが入っているので注意。入力ソースを追加したときなどに多い印象。

[%autowidth, cols="2*a"]
.サービス
|===
|Googleで検索 |チェック外す
|Spotlight |チェック外す
|辞書で調べる |なし
|===

[%autowidth, cols="2*a"]
.Spotlight
|===
|Spotlight検索を表示 |チェック外す
|===

[%autowidth, cols="2*a"]
.アプリケーション
|===
|すべてしまう |kbd:[Shift+Control+Option+Command+M]
|しまう |kbd:[Control+Option+Command+M]
|最小化 |kbd:[Control+Option+Command+M]
|Minimize All |kbd:[Shift+Control+Option+Command+M]
|Minimize |kbd:[Control+Option+Command+M]
|===

=== 入力ソース
`U.S.` や `英語` を消すには、`日本語` の設定で `英字` にチェックを入れる。`U.S.` や `英語` を消したあとは `日本語` も消していい。

== GitHub
=== 公開鍵・秘密鍵を生成
. `$ ssh-keygen -t rsa -b 4096`

. {blank}
+
----
Generating public/private rsa key pair.
Enter file in which to save the key (/Users/{user}/.ssh/id_rsa):
（何も入力せずに Enter を押す）

Enter passphrase (empty for no passphrase):
（パスフレーズを入力する）

Enter same passphrase again:
（もう一度入力する）
----

. 生成した鍵を確認する。
+
----
$ ls -l ~/.ssh/


id_rsa
id_rsa.pub
----

=== 秘密鍵を ssh-agent に登録
. {blank}
+
----
$ ssh-add ~/.ssh/id_rsa

Enter passphrase for /Users/{user}/.ssh/id_rsa:
（パスフレーズを入力）

Identity added: /Users/{user}/.ssh/id_rsa ({local host})
----

=== 公開鍵を GitHub に登録
. `$ pbcopy < ~/.ssh/id_rsa.pub`
. GitHub の `Settings > SSH and GPG keys > SSH keys` に公開鍵を登録する。

. `$ vim ~/.ssh/config` で以下を追加。
+
----
Host github
  HostName github.com
  IdentityFile ~/.ssh/id_rsa
  User git
----

. 接続を確認する。
+
----
$ ssh -T git@github.com

Hi {user}! You've successfully authenticated, but GitHub does not provide shell access.
----

. HTTPS 接続したことがあるリポジトリの `.git/config` を編集。
+
.編集前
----
[remote "origin"]
	url = https://github.com/{user}/{repository}.git
----
+
.編集後
----
[remote "origin"]
	url = github:{user}/{repository}.git
----

=== リポジトリを復元
. `$ mkdir ~/repos; cd ~/repos/`
. 必要なリポジトリを `git clone` する。

== その他の設定

=== プリンタ設定
* システム環境設定の「プリンタとスキャナ」からプリンタを登録する。
* 基本的に Mac 標準のドライバで OK。
